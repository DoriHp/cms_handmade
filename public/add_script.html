<!DOCTYPE html>
<html lang="vi">
<head>
	<title>Bot CMS - add script</title>
	<meta charset="utf-8">	
	<meta name="viewport" content="width = device-width, initial-scale = 1, shrink-to-fit = no">
	<meta name="theme-color" content="#574E4E">
	<meta name="msapplication-TileColor" content="#574E4E">
	<meta name="msapplication-navbutton-color" content="#574E4E">
	<meta name="apple-mobile-web-app-status-bar-style" content="#574E4E">
	<link rel="shortcut icon" href="image.jpg">
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
	<header>
		<h1 class="display-4">BotkitCMS</h1>
	</header>
	<div class="container">
		<div class="row" id='div_button'>
			<div class="btn-group" role="group" aria-label="Button">
				<button type="button" class="btn btn-secondary btn-info" onclick="window.location.href='/'">Danh sách</button>
				<button type="button" class="btn btn-secondary btn-toolbar" onclick="window.location.href='/script/add'">Thêm script</button>
				<button type="button" class="btn btn-secondary btn-warning">Hướng dẫn</button>
			</div>
		</div>
		<div class="row" id="div_form">
			<form class="col-12 border-info" method="POST">
				<div class="form-group row">
					<label for="inputCommand" class="col-sm-2 form-control-label">Lệnh điều khiển</label>
					<div class="col-sm-10">
						<input type="text" name="command" class="form-control" id="inputCommand" placeholder="Command">
					</div>
				</div>
				<div class="form-group row">
					<label for="inputDescription" class="col-sm-2 form-control-label">Mô tả</label>
					<div class="col-sm-10">
						<input type="text" name="description" class="form-control" id="inputDescription" placeholder="Description">
					</div>
				</div>
				<div class="form-group row">
					<label for="inputID" class="col-sm-2 form-control-label">Script ID</label>
					<div class="col-sm-10">
						<input type="text" name="id" class="form-control" id="inputID" placeholder="ID">
					</div>
				</div>
				<div class="form-group row">
					<label for="inputName" class="col-sm-2 form-control-label">Tên script</label>
					<div class="col-sm-10">
						<input type="text" name="name" class="form-control" id="inputName" placeholder="Name">
					</div>
				</div>
				<div class="form-group" id="trigger_area">
				  	<div class="form-group row" id="original1">
				  		<label class="col-2">Triggers</label>
				  		<label class="col-2">Trigger type</label>
						<div class="form-group col-3">
				    	<select name="type0" class="form-control">
					        <option value="string" selected>Chuỗi kí tự</option>
					        <option value="regexp">Regular Expression</option>
					    </select>
					  	</div>
					  	<label class="col-1">Trigger</label>
					  	<div class="form-group col-4">
					    	<input type="text" name="trigger0" class="form-control" placeholder="Trigger">
					  	</div>
				  	</div>
				  	<div class="form-group row" id="adding_trigger">
				  		<label class="col-2"></label>
				  		<div class="col-10 form-group">
				  			<button type="button" class="btn btn-outline-secondary col-12 form-group" id="adding_trigger" onclick="add_trigger()">Thêm trigger</button>
				  		</div>
				  	</div>
				</div>
				<div class="form-group row">
					<label for="inputVariables" class="col-2">Biến dữ liệu</label>
					<div class="form-group col-10">
				    	<input type="text" name="variables" class="form-control" id="inputVariables" placeholder="Variables">
				  	</div>
				</div>
				<div class="form-group row">
					<label for="inputTopic" class="col-2">Chủ đề</label>
					<div class="form-group col-10">
				    	<input type="text" name="topic" class="form-control" id="inputTopic" placeholder="Topic">
				  	</div>
				</div>
				<div class="form-group row">
					<label class="col-sm-2">Định dạng script</label>
					<div class="col-sm-10">
						<div class="radio">
							<label>
								<input class="key" type="radio" name="script" data-key="1" id="gridRadios1" value="text">
								Chuỗi kí tự thông thường
							</label>
						</div>
						<div class="radio">
							<label>
								<input class="key" type="radio" name="script" data-key="2" id="gridRadios2" value="facebook_template">
								Facebook template
							</label>
						</div>
						<div class="radio">
							<label>
								<input class="key" type="radio" name="script" data-key="3" id="gridRadios3" value="question">
								Câu hỏi
							</label>
						</div>
					</div>
				</div>
				<div class="form-group row comp" data-key="1">
					<label for="inputReply" class="col-2">Câu đối thoại</label>
					<div class="form-group col-10">
				    	<input type="text" name="reply_text0" class="form-control" id="inputReply" placeholder="Reply">
				  	</div>
				</div>
				<div class="form-group row comp" data-key="2">
					<label for="inputReply" class="col-2">Facebook_template</label>
					<div class="form-group col-10">
				    	<input type="text" name="text0" class="form-control" id="inputReply" placeholder="Reply">
				  	</div>
				</div>
				<div class="form-group row comp" data-key="3">
					<div class="form-group row">
						<label for="inputTextBefore" class="col-2">Lời mở đầu</label>
						<div class="form-group col-10">
					    	<input type="text" name="text_before0" class="form-control" id="inputTextBefore" placeholder="Text before">
					  	</div>
					</div>	
					<label for="inputQuestion" class="col-4"><i class="fas fa-question-circle"></i> Câu hỏi</label>
					<label for="inputQuickReplies" class="col-4"><i class="fab fa-replyd"></i> Câu trả lời nhanh</label>
					<label for="inputPayload" class="col-3"><i class="fab fa-replyd"></i> Payload </label>
					<div class="form-group row" >
						<div class="form-group col-4">
					    	<input type="text" name="question" class="form-control" id="inputQuestion" placeholder="Question">
					  	</div>
					  	<div class="form-group col-8" id="replies_area">
					  		<div class="form-group col-12 row" id="reply1">
					  			<div class="form-group col-6">
					  			<input type="text" name="quick_reply0" class="form-control reply" id="inputQuickReplies" placeholder="Option1">
					  		</div>
					  		<div class="form-group col-6">
					    		<input type="text" name="payload0" class="form-control payload" id="inputPayload" placeholder="Payload for option1">
					  		</div>
					  		</div>
					  		<div class="form-group col-12" id="adding_reply">
					  			<button type="button" class="btn btn-outline-secondary form-control" onclick="add_quick_reply()">Thêm câu trả lời nhanh</button>
					  		</div>
					  	</div>
					</div>
					<div class="form-group row">
					  	<label for="inputNextQSID" class="col-2">ID câu hỏi kế tiếp</label>
					  	<div class="form-group col-4">
					    	<input type="text" name="id_next_question" class="form-control" id="inputNextQSID" placeholder="Next question ID">
					  	</div>
					  	<label for="inputTextAfter" class="col-2">Lời kết thúc và cảm ơn</label>
					  	<div class="form-group col-4">
					    	<input type="text" name="text_after0" class="form-control" id="inputTextAfter" placeholder="Text after">
					  	</div>
					</div>	
				</div>
				<div class="form-group row">
					<div class="col-sm-12">
						<button type="button" onclick="submitData()" class="btn btn-success float-right">Lưu lại</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<script>
		const comps = Array.from(document.querySelectorAll('.comp'))
		comps.forEach(comp => comp.style.display = 'none')

		function display(e){
			comps.forEach(comp => comp.style.display = 'none')
		    var data_key = e.target.getAttribute('data-key')
		    console.log(data_key)
		    const selected = document.querySelector(`div[data-key="${data_key}"]`)
		    selected.style.display = 'block'
		}

		const keys = Array.from(document.querySelectorAll('.key'));
  		keys.forEach(key => key.addEventListener('click', display));

  		function add_trigger(){
  			console.log('Test button')
  			var trigger_area = document.getElementById('trigger_area')
  			var c = trigger_area.children;
		  	var count = 0
		  	for(var i = 0; i < c.length; ++i){
		    	if(c[i].tagName == "DIV")
		        count++
			}
		  	var node_before = document.getElementById('adding_trigger')
		  	var original1 = document.getElementById('original1')
		  	var newNode = original1.cloneNode(true)
		  	newNode.id = `original${count+1}`
		  	trigger_area.insertBefore(newNode, node_before)
		  	let labels = document.querySelectorAll(`#original${count+1} label`)
		  	labels.forEach(label => label.innerHTML = "")
		  	let select = document.querySelector(`#original${count+1} select`)
		  	select.name = `type${count - 1}`
		  	let input = document.querySelector(`#original${count+1} input`)
		  	input.name = `trigger${count - 1}`
  		}

  		function add_quick_reply(){
  			var node_before = document.getElementById('adding_reply')
  			var replies_area = document.getElementById('replies_area')
  			var reply1 = document.getElementById('reply1') 
		  	var newNode = reply1.cloneNode(true)
  			var c = replies_area.children;
		  	var count = 0
		  	var count_reply = 0
		  	for(var i = 0; i < c.length; ++i){
		    	if(c[i].tagName == "INPUT")
		        count++;
		    	count_reply = (count_reply + 2) / 2
			}

			newNode.id = `reply${count+1}`
		  	replies_area.insertBefore(newNode, node_before)
		  	let reply = document.querySelectorAll(`#reply${count+1} .col-6 .reply`)
		  	reply.name = `quick_reply${count - 1}`
		  	let payload = document.querySelectorAll(`#reply${count+1} .col-6 .payload`)
		  	payload.name = `payload${count - 1}`
  		}

  		function submitData(){

  		 	var formData = new FormData(document.querySelector('form'))
  		 	
		    var data = {}
		    for (var pair of formData.entries()) {
		      	data[pair[0]] = pair[1]
		    }
		    
		   	//tao array cua trigger
		    var i
			var array_triggers = [];
			for(i = 0; typeof data[`type${i}`] !== 'undefined'; i++){
			    array_triggers.push({fromType: data[`type${i}`], pattern: data[`trigger${i}`] })
			    delete data[`type${i}`]
			    delete data[`trigger${i}`]
			}
			data['triggers'] = array_triggers

			//xu ly du lieu cua script question
			data['scripts'] = []

			//script định dạng text hoặc fb_attachment
			data.scripts[0] = {}
			if(data.script == 'facebook_template'){
				data.scripts[0]['topic'] = data.topic
				delete data.topic

				data.scripts[0].script = []
				data.scripts[0].script[0] = {}
				data.scripts[0].script[0].text = []
				
				for(i = 0; typeof data[`text${i}`] !== 'undefined'; i++){
				    data.scripts[0].script[0].text.push(data[`text${i}`])
				    delete data[`text${i}`]
					}
				
				data.scripts[0].script[0].fb_attachment = {}
				data.scripts[0].script[0].fb_attachment.template_type = ""
				data.scripts[0].script[0].fb_attachment.elements = []
				data.scripts[0].script[0].fb_attachment.elements[0] = {}

				data.scripts[0].script[0].fb_attachment.elements[0].title = ""
				data.scripts[0].script[0].fb_attachment.elements[0].subtitle = ""
				data.scripts[0].script[0].fb_attachment.elements[0].image_url = ""
				data.scripts[0].script[0].fb_attachment.elements[0].button = []

				data.scripts[0].script[0].fb_attachment.elements[0].button[0] = {}
				data.scripts[0].script[0].fb_attachment.elements[0].button[0].fromType = ""
				data.scripts[0].script[0].fb_attachment.elements[0].button[0].title = ""
				data.scripts[0].script[0].fb_attachment.elements[0].button[0].url
					= ""
				data.scripts[0].script[0].fb_attachment.elements[0].button[0].webview_height_ratio = ""
				data.scripts[0].script[0].fb_attachment.elements[0].button[0].payload = ""

				data.scripts[0].script[0].fb_attachment.action = ""

				data.scripts[1] = {}
				data.scripts[1].text_after = []
				for(i = 0; typeof data[`text_after${i}`] !== 'undefined'; i++){
					data.scripts[1].text_after.push(data[`text_after${i}`])
					delete data[`text_after${i}`]
				}
				delete data.text_before0
				delete data.text_after0
				delete data.question
				delete data.quick_reply0
				delete data.payload0
			}else if(data.script == 'question'){
				data.scripts[0] = {}
				data.scripts[0].text_before = []
				for(i = 0; typeof data[`text_before${i}`] !== 'undefined'; i++){
					data.scripts[0].text_before.push(data[`text_before${i}`])
					delete data[`text_before${i}`]
				}

				data.scripts[1] = {}
				data.scripts[1].question = {}
				data.scripts[1].question.text = data.question
				delete data.question
				//tao array cua quick reply
				var array_replies = []

				for(i = 0; typeof data[`quick_reply${i}`] !== 'undefined'; i++){
				    array_replies.push({title: data[`quick_reply${i}`], payload: data[`payload${i}`] ,
				    	content_type: 'text'
					})
				    delete data[`payload${i}`]
				    delete data[`quick_reply${i}`]
				}
				data.scripts[1].question.quick_replies = array_replies
				data.scripts[2] = {}
				data.scripts[2].text_after = []
				for(i = 0; typeof data[`text_after${i}`] !== 'undefined'; i++){
					data.scripts[2].text_after.push(data[`text_after${i}`])
					delete data[`text_after${i}`]
				}
				delete data.text0
				delete data.topic

			}

			delete data.script
			delete data.reply_text0

  			axios.post('/script/add',{
  				headers: {
  					'Content-Type': 'application/json',
  				},
  				data: JSON.stringify(data)
  			}).then(function(response){
  				if(response.status == 200){
  					alert("Lưu script thành công!")
  				}else{
  					alert("Lưu script thất bại!")
  				}
  			}).catch(function(error){
  				console.log(error)
  			})
  		}
	</script>
</body>
</html>
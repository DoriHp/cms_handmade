<!DOCTYPE html>
<html lang="vi">
<head>
	<title>Bot CMS</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="/css/style.css">	
	<meta name="viewport" content="width = device-width, initial-scale = 1, shrink-to-fit = no">
	<meta name="theme-color" content="#574E4E">
	<meta name="msapplication-TileColor" content="#574E4E">
	<meta name="msapplication-navbutton-color" content="#574E4E">
	<meta name="apple-mobile-web-app-status-bar-style" content="#574E4E">
	<link rel="shortcut icon" href="/image/image.jpg">
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script type="text/javascript" scr="script.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
	<header>
		<h1 class="display-4">BotkitCMS</h1>
	</header>
	<div class="container">
		<div class="row" id='div_button'>
			<div class="col-5 btn-group" role="group" aria-label="Button" style="padding-left: 0">
				<button type="button" class="btn btn-secondary btn-info" onclick="window.location.href='/'">Danh sách</button>
				<button type="button" class="btn btn-secondary btn-toolbar" onclick="window.location.href='/script/add/question'">Thêm script</button>
				<button type="button" class="btn btn-secondary btn-warning" onclick="window.location.href='/broadcast'">Tin nhắn hàng loạt</button>
			</div>
			</div>
		<div class="row">
			<div id='div_table' class="col-12">
				<table class="table table-striped table-bordered table-sm" id='table_body' cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>Script ID</th>
							<th>Intent</th>
							<th>Trigger</th>
							<th>Script type</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>		
			</div>
		</div>
	</div>
	<script src="/socket.io/socket.io.js"></script>

	<script>
		// location.hash = "main"
		(function(){
			axios.get('/script',{
				headers:{
					'Content-Type': 'application/json',
					}
				}).then(function(response){
					var a = JSON.stringify(response.data)
					showOut(a)
				}).catch(function(error){
					console.log(error)
				})
		})()

		function showOut(items){
			var table_body = document.querySelector('#table_body tbody')
			var a = JSON.parse(items)
			var index = 0
			for(let i of a){
				let row = table_body.insertRow(index)
				row.id = i._id
				
				var cell0 = row.insertCell(0)
				var cell1 = row.insertCell(1)
				var cell2 = row.insertCell(2)
				var cell3 = row.insertCell(3)
				
				cell0.innerHTML = (i.id == undefined)?"N/A":i.id
				cell1.innerHTML = (i.type == undefined)?"N/A":i.type
				cell2.innerHTML = (i.triggers == undefined)?"N/A":i.triggers.join(', ')
				
				if(!Array.isArray(i.script)){
					cell3.innerHTML = (i.script.type == undefined)?"N/A":i.script.type
				}else{
					var str = []
					for(let j of i.script){
						str.push(j.type)
					}	
					cell3.innerHTML = str.join(', ')
				}
				row.addEventListener('click', getProperties)

				index++
				
			}
		}

		function getProperties(e){
			var _id = this.id
			window.open('/script/properties/' + encodeURIComponent(_id), '_blank')
		}

		var socket = io(); // start a connection to the server

        socket.on('insert script', function(data) {
            console.log('script inserted');

            var index = document.querySelector("#table_body tbody").rows.length;

            var i = data.script
            let row = table_body.insertRow(index)
			row.id = data.script._id
			var cell0 = row.insertCell(0)
			var cell1 = row.insertCell(1)
			var cell2 = row.insertCell(2)
			var cell3 = row.insertCell(3)
			
			cell0.innerHTML = (i.id == undefined)?"N/A":i.id
			cell1.innerHTML = (i.type == undefined)?"N/A":i.type
			cell2.innerHTML = (i.triggers == undefined)?"N/A":i.triggers.join(', ')

			if(!Array.isArray(i.script)){
				cell3.innerHTML = (i.script.type == undefined)?"N/A":i.script.type
			}else{
				var str = []
				for(let j of i.script){
					str.push(j.type)
				}	
				cell3.innerHTML = str.join(', ')
			}
			row.addEventListener('click', getProperties)

        });

        socket.on('update script',function(data){
            console.log('updated! script');
			
			var row = document.getElementById(data.script._id)
			var cells = row.querySelectorAll("*")
			cells[0].textContent.trim() == data.script.id
			cells[1].innerHTML = (data.script.type == undefined)?"N/A":data.script.type
			cells[2].innerHTML = (data.script.triggers == undefined)?"N/A":data.script.triggers.join(', ')
			
			if(!Array.isArray(data.script.script)){
				cells[3].innerHTML = (data.script.script.type == undefined)?"N/A":data.script.script.type
			}else{
				var str = []
				for(let j of data.script.script){
					str.push(j.type)
				}	
				cells[3].innerHTML = str.join(', ')
			}
		})

		socket.on('delete script', function(data){
			console.log('deleted script ' + data.id)
			var row = document.getElementById(data._id)
			row.parentNode.removeChild(row)
		})
	</script>
</body>
<footer></footer>
</html>

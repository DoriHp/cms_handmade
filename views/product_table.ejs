<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
<!-- END OF PAGE LEVEL PLUGIN -->
</header>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Quản lý danh sách sản phẩm
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                        <% include _layouts/toolbar %>
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                    <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="row">
                        <div class="col-md-12">
                            <!-- BEGIN SAMPLE TABLE PORTLET-->
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="far fa-list-alt"></i>Danh sách sản phẩm</div>
                                    <div class="actions">
                                       <button type="button" onclick="displayForm()" class="btn btn-default btn-sm">
                                            <i class="fa fa-plus"></i> Thêm sản phẩm </button>
                                    </div>
                                    <div class="tools" style="margin-right: 10px;">
                                    	<a class="collapse"> </a>
                                        <a class="reload" onclick="getEmployee()"> </a>
                                    </div>
                                </div>
                                <div class="portlet-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1_2">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                        <input type="checkbox" class="checkboxes" value="1" disabled />
                                                        <span></span>
                                                        </label>
                                                    </th>
                                                    <th> Tên gói cước </th>
                                                    <th> Giá gói </th>
                                                    <th> Chu kỳ gói </th>
                                                    <th> Hoa hồng </th>
                                                    <th> Thao tác </th>
                                                    <th> Cho phép tư vấn qua chatbot </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% for (var i = 0; i < data.length; i++) { -%>
                                                    <tr class="odd gradeX" id="<%= data[i]._id %>" >
                                                        <td>
                                                            <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                                <input id="<%= data[i]._id %>" type="checkbox" class="checkboxes" value="1"/>
                                                                <span></span>
                                                            </label>
                                                        </td>
                                                        <td><%= data[i].ten_goi_cuoc %></td>
                                                        <td><%= data[i].gia_goi %></td>
                                                        <td><%= data[i].chu_ky %></td>
                                                        <td><%= data[i].hoa_hong_msocial %></td>
                                                        <td>
                                                            <i class="fas fa-trash" style="color: red;"></i> <i class="fas fa-info-circle" style="color: #3598dc;" id='<%= data[i]._id %>'></i>
                                                        </td>
                                                        <td>
                                                            <label class="switch"><input class="input_status" type="checkbox" <% if (data[i].public) { -%>
                                                                checked
                                                            <% } -%> ><span class="slide round"></span></label>
                                                        </td>
                                                    </tr>
                                                <% } -%>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!-- END SAMPLE TABLE PORTLET-->
                        </div>
                    </div>
                    <hr>
                    <!-- BEGIN EDITING AND ADDING FORM -->
                    <div id="adding_div" class="row" style="display: none;">
                    	<div class="col-md-12">
                    		<div class="portlet box green">
	                    		<div class="portlet-title">
	                                <div class="caption">
	                                    <i class="fas fa-info-circle"></i>Thông tin sản phẩm</div>
	                                <div class="actions" style="margin-left: 10px;">
	                                	<button type="button" onclick="enableEdit()" class="btn btn-default btn-sm">
	                                        <i class="far fa-edit"></i> Enable editing </button>
	                                    <button type="button" onclick="closeForm()" class="btn btn-default btn-sm" style="border: none;">
	                                    	<i class="far fa-times-circle" style="color: red"></i>
	                                    </button>
	                                </div>
	                                <div class="tools">
                                        <a class="collapse"> </a>
                                        <a class="reload"> </a>
                                    </div>
	                            </div>
                    			<div class="portlet-body form">
                                <!-- BEGIN FORM-->
                                <form action="#" class="form-horizontal" id="product_data">
                                    <div class="form-body">
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Tên gói cước</label>
                                            <div class="col-md-4">
                                                <input type="text" id="ten_goi" name="ten_goi" class="form-control input-circle" placeholder="Tên gói">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Giá gói</label>
                                            <div class="col-md-4">
                                                <input type="text" id="gia_goi" name="gia_goi" class="form-control input-circle" placeholder="Giá gói cước">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Chu kỳ</label>
                                            <div class="col-md-3">
                                                <input type="text" id="chu_ky" name="chu_ky" class="form-control input-circle" placeholder="Chu kỳ gói">
                                            </div>
                                            <div class="col-md-1" style="padding-left: 0;">
                                            	<select class="form-control input-circle" id="don_vi_1" name="don_vi_1" style="padding: 0;">
														<option value="day">Ngày</option>
														<option value="month">Tháng</option>
														<option value="year">Năm</option>
                                            	</select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Khuyến mại chu kỳ đầu</label>
                                            <div class="col-md-3">
                                                <input type="text" id="khuyen_mai_chu_ky_dau" name="khuyen_mai_chu_ky_dau" class="form-control input-circle" placeholder="Khuyến mại chu kỳ đầu">
                                            </div>
                                            <div class="col-md-1" style="padding-left: 0;">
                                            	<select class="form-control input-circle" id="don_vi_2" name="don_vi_2" style="padding: 0;">
														<option value="day">Ngày</option>
														<option value="month">Tháng</option>
														<option value="year">Năm</option>
                                            	</select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Hoa hồng</label>
                                            <div class="col-md-3">
                                                <input type="text" id="hoa_hong_msocial" name="hoa_hong_msocial" class="form-control input-circle" placeholder="Hoa hồng msocial">
                                            </div>
                                            <div class="col-md-1"  style="padding-left: 0;">
                                            	<input type="text" class="form-control input-circle" placeholder="VND" disabled>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Ưu đãi nội mạng</label>
                                            <div class="col-md-4">
                                                <input type="text" id="uu_dai_noi_mang" name="uu_dai_noi_mang" class="form-control input-circle" placeholder="Ưu đãi nội mạng">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Ưu đãi ngoại mạng</label>
                                            <div class="col-md-4">
                                                <input type="text" id="uu_dai_ngoai_mang" name="uu_dai_ngoai_mang" class="form-control input-circle" placeholder="Ưu đãi ngoại mạng">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Ưu đãi data</label>
                                            <div class="col-md-4">
                                                <input type="text" id="uu_dai_data" name="uu_dai_data" class="form-control input-circle" placeholder="Ưu đãi data">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-3 control-label">Ưu đãi khác</label>
                                            <div class="col-md-4">
                                                <input type="text" id="uu_dai_khac" name="uu_dai_khac" class="form-control input-circle" placeholder="Ưu đãi khác">
                                            </div>
                                            <label class="col-md-3 control-label">Cho phép trả lời bằng chatbot</label>
                                            <div class="col-md-1" style="padding-left: 0;">
                                            	<select id="public" name="public" class="form-control input-circle" style="padding: 0;">
                                            		<option value="true">Có</option>
                                            		<option value="false">Không</option>
                                            	</select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <div class="row">
                                            <div class="col-md-offset-3 col-md-9">
                                                <button id="save_change" type="button" onclick="updateProduct()" class="btn btn-circle green" style="display: none;" disabled>Lưu thay đổi</button>
                                                <button id="adding" type="button" onclick="addProduct()" class="btn btn-circle green" style="display: none;">Lưu lại</button>
                                                <button type="button" class="btn btn-circle grey-salsa btn-outline">Hủy bỏ</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <!-- END FORM-->
                            	</div>
	                        </div>
                    	</div>
                    </div>
                    <!-- END OF EDITING AND ADDING FORM -->
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <% include _layouts/quick_sidebar %>
    </div>
    <!-- END CONTAINER -->
<script type="text/javascript">
    // location.hash = "main"
    const arr = [
            {
                en: 'day',
                vi: 'ngày'
            },
            {
                en: 'month',
                vi: 'tháng'
            },
            {
                en: 'year',
                vi: 'name'
            }
        ]
    var cb_select = []
    scrollTo(document.body, document.getElementById('sample_1_2'), 200)
    var select_id
    var i_trash = document.getElementsByClassName('fa-trash')
    var i_info = document.getElementsByClassName('fa-info-circle')
    var input_status = document.getElementsByClassName('input_status')
    var checkboxes = document.getElementsByClassName('checkboxes')
    for(let i = 0; i < i_trash.length; i++){
        i_trash[i].addEventListener('click', delProduct)
        i_info[i].addEventListener('click', getProperties)
        input_status[i].addEventListener('click', change_public_status)
        checkboxes[i].addEventListener('change', multi_select)
    }
    const adding_form = document.getElementById('adding_div')
    function getEmployee(){
        axios.get('/manager/product/list',{
            headers:{
                'Content-Type': 'application/json',
                }
            }).then(function(response){
                var a = JSON.stringify(response.data)
                showOut(a)
            }).catch(function(error){
                console.log(error)
            })
    }   

    function multi_select(e){
        if(this.checked){
            cb_select.push(this.id)
        }else{
            var index = array.indexOf(this.id)
            if (index > -1) {
              cb_select.splice(index, 1)
            }
        }
    }

    //clear old rows of table
    function clear_table(){
        var new_tbody = document.createElement('tbody') 
        var old_tbody = document.querySelector('tbody')
        old_tbody.parentNode.replaceChild(new_tbody, old_tbody)
    }

    function showOut(items){
        clear_table()
        var table_body = document.querySelector('table tbody')
        var a = JSON.parse(items)
        var index = 0
        for(let i of a){
            let row = table_body.insertRow(index)
            row.id = i._id
            var cell0 = row.insertCell(0)
            var cell1 = row.insertCell(1)
            var cell2 = row.insertCell(2)
            var cell3 = row.insertCell(3)
            var cell4 = row.insertCell(4)
            var cell5 = row.insertCell(5)
            var cell6 = row.insertCell(6)
            
            cell0.innerHTML = '<label class="mt-checkbox mt-checkbox-single mt-checkbox-outline"><input type="checkbox" class="checkboxes" value="1" /><span></span></label>'
            cell1.innerHTML = (i.ten_goi_cuoc == undefined)?"N/A": i.ten_goi_cuoc
            cell2.innerHTML = (i.gia_goi == undefined)?"N/A":i.gia_goi
            cell3.innerHTML = (i.chu_ky == undefined)?"N/A":i.chu_ky
            cell4.innerHTML = (i.hoa_hong_msocial == undefined)?"N/A":i.hoa_hong_msocial
            cell5.innerHTML = `<i class="fas fa-trash" style="color: red" id=${i._id}></i> <i class="fas fa-info-circle" style="color: #3598dc" id=${i._id}></i>`
            index++
            if(i.public){
                cell6.innerHTML = `<label class="switch"><input class="input_status" type="checkbox" checked id=${i._id}><span class="slide round"></span></label>`
            }else{
                cell6.innerHTML = `<label class="switch"><input class="input_status" type="checkbox" id=${i._id}><span class="slide round"></span></label>`
            }
            
        }
        var icons1 = document.getElementsByClassName('fa-trash')
        for(let i of icons1){
            i.addEventListener('click', delProduct)
        }

        var icons2 = document.getElementsByClassName('fa-info-circle')
        for(let i of icons2){
            i.addEventListener('click', getProperties)
        }

        var checkbox = document.getElementsByClassName('input_status')
        for(let i of checkbox){
            i.addEventListener('change', change_public_status)
        }
    }
    function getProperties(e){
        var _id = this.id
        select_id = this.id
        axios.get('/manager/product/properties/' + encodeURIComponent(_id))
        .then(function(response){
            if(response.status == 200){
                var data = response.data
                displayForm()
                adding_form.querySelector('#ten_goi').value = data.ten_goi_cuoc
                adding_form.querySelector('#gia_goi').value = data.gia_goi
                adding_form.querySelector('#chu_ky').value = exec_time(data.chu_ky)[0]
                adding_form.querySelector('#don_vi_1').value = exec_time(data.chu_ky)[1]
                adding_form.querySelector('#hoa_hong_msocial').value = data.hoa_hong_msocial
                adding_form.querySelector('#khuyen_mai_chu_ky_dau').value = exec_time(data.khuyen_mai_chu_ky_dau)[0]
                adding_form.querySelector('#don_vi_2').value = exec_time(data.khuyen_mai_chu_ky_dau)[1]
                adding_form.querySelector('#uu_dai_noi_mang').value = (!data.uu_dai_noi_mang)?"N/A":data.uu_dai_noi_mang
                adding_form.querySelector('#uu_dai_ngoai_mang').value = (!data.uu_dai_ngoai_mang)?"N/A":data.uu_dai_ngoai_mang
                adding_form.querySelector('#uu_dai_data').value = (!data.uu_dai_data)?"N/A":data.uu_dai_data
                adding_form.querySelector('#uu_dai_khac').value = (!data.uu_dai_khac)?"N/A":data.uu_dai_khac
                adding_form.querySelector('#public').value = data.public
                adding_form.querySelectorAll('input').forEach(input => input.disabled = true)
                adding_form.querySelectorAll('select').forEach(select => select.disabled = true)
                document.getElementById('save_change').style.display = 'inline-block'
                document.getElementById('adding').style.display = 'none'
            }else{ 
                alert('Không tìm thấy dữ liệu về sản phẩm!')
                return
            }
        })
        .catch(function(error){
            alert('Đã có lỗi xảy ra, vui lòng thử lại sau!' + error)
        })
    }

    function updateProduct(){
        var new_data = getData()
        console.log(new_data)
        axios.get('/manager/product/properties/' + encodeURIComponent(select_id))
        .then(function(response){
            if(response.status == 200){
                var _id = response.data._id
                delete(response.data._id)
                console.log(response.data)
                if(deepCompare(response.data, new_data)){
                    alert('Dữ liệu không thay đổi!')
                    return
                }else{
                    var conf = confirm("Bạn chắc chắn muốn lưu thay đổi?")
                    if(!conf) return
                    axios.post('/manager/product/update/' + encodeURIComponent(select_id), {
                        headers:{
                            'Content-Type': 'application/json'
                        },
                        data: new_data
                    }).then(function(res){
                        if(res.status == 200){
                            alert('Thay đổi dữ liệu thành công!')
                            location.reload()
                        }else{
                            alert('Đã có lỗi xảy ra, vui lòng thử lại sau!')
                        }
                    }).catch(function(error){
                        alert('Request 2: Đã có lỗi xảy ra, vui lòng thử lại sau!' + error)
                    })
                }
            }else{
                alert('Đã có lỗi xảy ra, vui lòng thử lại sau!')
            }
        })
        .catch(function(error){
            alert('Request 1: Đã có lỗi xảy ra, vui lòng thử lại sau!' + error)
        })
    }

    function enableEdit(){
        adding_form.querySelectorAll('input').forEach(input => input.disabled = false)
        adding_form.querySelectorAll('select').forEach(select => select.disabled = false)
        adding_form.querySelector('#save_change').disabled = false
    }

    function change_public_status(e){
        var public = (this.checked)?true:false
        var _id = this.id
        axios.post('/manager/product/update/' + encodeURIComponent(_id), {
            headers:{
                'Content-Type': 'application/json'
            },
            data: {
                public: public
            }
        }).then(function(response){
            if(response.status == 200){
                alert('Đã thay đổi trạng thái tư vấn của sản phầm')
            }else{
                alert('Đã có lỗi xảy ra, vui lòng thử lại!')
                if(this.checked){
                    this.checked = false
                }else{
                    this.checked = true
                }
            }
        }).catch(function(error){
            alert('Đã có lỗi xảy ra' + error )
            if(this.checked){
                this.checked = false
            }else{
                this.checked = true
            }
        })
    }
    //xóa sản phẩm
    function delProduct(e){
        var _id = this.id
        var conf = confirm('Bạn chắc chắn muốn xóa sản phẩm này?')
        if(!conf) return
        axios.delete(`/manager/product/delete/${_id}`).
        then(function(response){
            if(response.status == 200){
                alert('Xóa sản phẩm khỏi danh sách thành công!')
                location.reload()
            }else{
                alert('Đã có lỗi xảy ra, vui lòng thử lại!')
            }
        }).catch(function(error){
            alert('Đã có lỗi xảy ra, vui lòng thử lại!')
        })
    }
    //thêm sản phẩm
    function getData(){
        var formData = new FormData(document.getElementById('product_data'))
        var data = {}
        for (var pair of formData.entries()) {
            data[pair[0]] = (pair[1] == 'N/A' || pair[1] == "")?"":pair[1]
        }   
        var submit_data = {}

        var don_vi_1, don_vi_2
        for(let i of arr){
            if(i.en == data.don_vi_1) don_vi_1 = i.vi
            if(i.en == data.don_vi_2) don_vi_2 = i.vi
        }
        submit_data.chu_ky = data.chu_ky + " " + don_vi_1
        submit_data.khuyen_mai_chu_ky_dau = data.khuyen_mai_chu_ky_dau + " " + don_vi_2
        submit_data.ten_goi_cuoc = data.ten_goi
        submit_data.gia_goi = parseInt(data.gia_goi)
        submit_data.hoa_hong_msocial = parseInt(data.hoa_hong_msocial)
        submit_data.uu_dai_noi_mang = data.uu_dai_noi_mang
        submit_data.uu_dai_ngoai_mang = data.uu_dai_ngoai_mang
        submit_data.uu_dai_khac = data.uu_dai_khac
        submit_data.uu_dai_data = data.uu_dai_data
        submit_data.public = (data.public)?true:false
        return submit_data
    }

    function addProduct(){
        var submit_data = getData()
        axios.post('/manager/product/adding',{
            headers:{
                'Content-Type': 'application/json'
            },
            data: submit_data
        }).then(function(response){
            if(response.status == 200){
                alert('Thêm dữ liệu sản phẩm thành công!')
                location.reload()
            }else{
                alert('Đã có lỗi xảy ra, vui lòng thử lại!')
            }
        }).catch(function(error){
            alert('Đã có lỗi xảy ra, vui lòng thử lại!')
        })
    }

    function exec_time(data){
        var result = []
        var numberPattern = /\d+/g
        result[0] = data.match(numberPattern)
        for(let i of arr){
            if(data.search(i.vi) != -1){
                result[1] = i.en
                break
            }
        }
        return result
    }

    //cuộn trang tới khu vực thêm sp
    function scrollTo(element, to, duration) {
        if (duration <= 0) return
        var difference = to - element.scrollTop
        var perTick = difference / duration * 10

        setTimeout(function() {
            element.scrollTop = element.scrollTop + perTick
            if (element.scrollTop === to) return
            scrollTo(element, to, duration - 10)
        }, 10)
    }

    function displayForm(){
        adding_form.querySelectorAll('input').forEach(input => input.value = "")
        adding_form.querySelectorAll('select').forEach(select => select.selectedIndex = 0)
        adding_form.style.display = 'block'
        scrollTo(document.body, adding_form.offsetTop, 400)
        adding_form.querySelectorAll('input').forEach(input => input.disabled = false)
        adding_form.querySelectorAll('select').forEach(select => select.disabled = false)
        document.getElementById('save_change').style.display = 'none'
        document.getElementById('adding').style.display = 'inline-block'
    }

    function closeForm(){
        adding_form.style.display = 'none'
    }

    function deepCompare () {
      var i, l, leftChain, rightChain;

      function compare2Objects (x, y) {
        var p;

        if (isNaN(x) && isNaN(y) && typeof x === 'number' && typeof y === 'number') {
             return true;
        }

        if (x === y) {
            return true;
        }

        if ((typeof x === 'function' && typeof y === 'function') ||
           (x instanceof Date && y instanceof Date) ||
           (x instanceof RegExp && y instanceof RegExp) ||
           (x instanceof String && y instanceof String) ||
           (x instanceof Number && y instanceof Number)) {
            return x.toString() === y.toString();
        }

        // At last checking prototypes as good as we can
        if (!(x instanceof Object && y instanceof Object)) {
            return false;
        }

        if (x.isPrototypeOf(y) || y.isPrototypeOf(x)) {
            return false;
        }

        if (x.constructor !== y.constructor) {
            return false;
        }

        if (x.prototype !== y.prototype) {
            return false;
        }

        // Check for infinitive linking loops
        if (leftChain.indexOf(x) > -1 || rightChain.indexOf(y) > -1) {
             return false;
        }

        for (p in y) {
            if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
                return false;
            }
            else if (typeof y[p] !== typeof x[p]) {
                return false;
            }
        }

        for (p in x) {
            if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
                return false;
            }
            else if (typeof y[p] !== typeof x[p]) {
                return false;
            }

            switch (typeof (x[p])) {
                case 'object':
                case 'function':

                    leftChain.push(x);
                    rightChain.push(y);

                    if (!compare2Objects (x[p], y[p])) {
                        return false;
                    }

                    leftChain.pop();
                    rightChain.pop();
                    break;

                default:
                    if (x[p] !== y[p]) {
                        return false;
                    }
                    break;
            }
        }

            return true;
          }

          if (arguments.length < 1) {
            return true; //Die silently? Don't know how to handle such case, please help...
            // throw "Need two or more arguments to compare";
          }

          for (i = 1, l = arguments.length; i < l; i++) {

              leftChain = []; //Todo: this can be cached
              rightChain = [];

              if (!compare2Objects(arguments[0], arguments[i])) {
                  return false;
              }
          }

          return true;
    }
</script>
<% include _layouts/global_plugin %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script src="/assets/global/scripts/datatable.js" type="text/javascript"></script>
<script src="/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
<script src="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL SCRIPTS -->
<script src="/assets/pages/scripts/table-datatables-managed.min.js" type="text/javascript"></script>
<!-- END PAGE LEVEL SCRIPTS -->
<% include _layouts/footer %>
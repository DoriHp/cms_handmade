<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL STYLES -->
<link href="/assets/pages/css/profile.min.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL STYLES -->
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Hồ sơ người dùng
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                    <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="row">
                        <div class="col-md-12">
                            <!-- BEGIN PROFILE SIDEBAR -->
                            <div class="profile-sidebar">
                                <!-- PORTLET MAIN -->
                                <div class="portlet light profile-sidebar-portlet bordered">
                                    <!-- SIDEBAR USERPIC -->
                                    <div class="profile-userpic">
                                        <img src="/image/user.png" class="img-responsive" alt="" style="height: auto;"> </div>
                                    <!-- END SIDEBAR USERPIC -->
                                    <!-- SIDEBAR USER TITLE -->
                                    <div class="profile-usertitle">
                                        <div class="profile-usertitle-name"> <%= user.name %> </div>
                                        <div class="profile-usertitle-job"> <%= user.role %> </div>
                                    </div>
                                    <!-- END SIDEBAR USER TITLE -->
                                    <!-- SIDEBAR MENU -->
                                    <div class="profile-usermenu">
                                        <ul class="nav">
                                            <li class="active">
                                                <a href="page_user_profile_1_account.html">
                                                    <i class="icon-settings"></i> Cài đặt tài khoản </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- END MENU -->
                                </div>
                                <!-- END PORTLET MAIN -->
                            </div>
                            <!-- END BEGIN PROFILE SIDEBAR -->
                            <!-- BEGIN PROFILE CONTENT -->
                            <div class="profile-content">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="portlet light bordered">
                                            <div class="portlet-title tabbable-line">
                                                <div class="caption caption-md">
                                                    <i class="icon-globe theme-font hide"></i>
                                                    <span class="caption-subject font-blue-madison bold uppercase">Tài khoản cá nhân</span>
                                                </div>
                                                <ul class="nav nav-tabs">
                                                    <li class="active">
                                                        <a href="#tab_1_1" data-toggle="tab">Thông tin người dùng</a>
                                                    </li>
                                                    <li>
                                                        <a href="#tab_1_2" data-toggle="tab">Đổi mật khẩu</a>
                                                    </li>
                                                    <% if (user.role == 'admin') { -%>
                                                        <li>
                                                            <a href="#tab_1_3" data-toggle="tab">Thêm mới tài khoản</a>
                                                        </li>
                                                        <li>
                                                            <a href="#tab_1_4" data-toggle="tab">Reset mật khẩu người dùng</a>
                                                        </li>
                                                    <% } -%>
                                                </ul>
                                            </div>
                                            <div class="portlet-body">
                                                <div class="tab-content">
                                                    <!-- PERSONAL INFO TAB -->
                                                    <div class="tab-pane active" id="tab_1_1">
                                                        <form role="form" id="per_info_form">
                                                            <div class="form-group">
                                                                <label class="control-label">Tên tài khoản</label>
                                                                <input type="text" placeholder="Account" class="form-control" name="account" value="<%= user.username %>" disabled> </div>
                                                            <div class="form-group">
                                                                <label class="control-label">Tên người dùng</label>
                                                                <input type="text" placeholder="Username" class="form-control" name="username" value="<%= user.name %>" disabled> </div>
                                                            <div class="form-group">
                                                                <label class="control-label">Email</label>
                                                                <input type="text" placeholder="Email người dùng" class="form-control" name="email" value="<%= user.email %>" disabled> </div>
                                                        </form>
                                                    </div>
                                                    <!-- END PERSONAL INFO TAB -->
                                                    <!-- CHANGE PASSWORD TAB -->
                                                    <div class="tab-pane" id="tab_1_2">
                                                        <form action="#" id="change_pw_form">
                                                            <div class="form-group">
                                                                <label class="control-label">Mật khẩu hiện tại</label>
                                                                <input type="password" class="form-control" name="currentPW" id="currentPW" pattern="[\Da-zA-Z0-9]{8,20}" title="Mật khẩu phải có độ dài 8 ~ 20 kí tự, có thể sử dụng kí tự đặc biệt"/> </div>
                                                            <div class="form-group">
                                                                <label class="control-label">Mật khẩu mới</label>
                                                                <input type="password" class="form-control" name="newPW" id="newPW" pattern="[\Da-zA-Z0-9]{8,20}" title="Mật khẩu phải có độ dài 8 ~ 20 kí tự, có thể sử dụng kí tự đặc biệt"/> </div>
                                                            <div class="form-group">
                                                                <label class="control-label">Nhập lại mật khẩu</label>
                                                                <input type="password" class="form-control" name="reEnterPW" id="reNewPW" /> </div>
                                                            <div class="margin-top-10">
                                                                <a href="javascript:;" onclick="change_pw()" class="btn green"> Đổi mật khẩu </a>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    <!-- END CHANGE PASSWORD TAB -->
                                                    <!-- ADD NEW USER TAB -->
                                                    <% if (user.role == 'admin') { -%>
                                                        <div class="tab-pane" id="tab_1_3">
                                                            <form action="#" id="adding_form">
                                                                <div class="form-group">
                                                                    <label class="control-label">Tên đăng nhập</label>
                                                                    <input type="text" class="form-control" name="username" id="username" pattern="[a-zA-Z0-9]{5,20}" title="Tên đăng nhập phải có độ dài 5 ~ 20 kí tự, không chứa kí tự đặc biệt"/> 
                                                                </div>
                                                                <div class="form-group">
                                                                    <label class="control-label">Tên người dùng</label>
                                                                    <input type="text" class="form-control" name="name" id="name"> 
                                                                </div>
                                                                <div class="form-group">
                                                                    <label class="control-label">Mật khẩu</label>
                                                                    <input type="password" class="form-control" name="password" id="password" pattern="[\Da-zA-Z0-9]{8,20}" title="Mật khẩu phải có độ dài 8 ~ 20 kí tự, có thể sử dụng kí tự đặc biệt"/> 
                                                                </div>
                                                                <div class="form-group">
                                                                    <label class="control-label">Email</label>
                                                                    <input type="email" class="form-control" name="email" id="email"/> </div>
                                                                <div class="form-group">
                                                                    <label class="control-label">Chọn quyền</label>
                                                                    <select class="form-control" id="role" name="role">
                                                                            <option value="supervisor">Supervisor</option>
                                                                            <option value="user">User</option>
                                                                    </select>
                                                                </div>
                                                                <div class="margin-top-10">
                                                                    <a href="javascript:;" onclick="add_user()" class="btn green"> Thêm người dùng </a>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <!-- END OF ADDING FORM -->
                                                        <!-- RESET PASSWORD TAB -->
                                                        <div class="tab-pane" id="tab_1_4">
                                                            <form action="#" id="reset_form">
                                                                <div class="form-group">
                                                                    <label class="control-label">Tên đăng nhập</label>
                                                                    <input type="text" class="form-control" name="username" id="username" pattern="[a-zA-Z0-9]{5,20}" title="Tên đăng nhập phải có độ dài 5 ~ 20 kí tự, không chứa kí tự đặc biệt"/> 
                                                                </div>
                                                                <div class="margin-top-10">
                                                                    <a href="javascript:;" onclick="reset_pw()" class="btn green"> Reset mật khẩu </a>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    <!-- END OF RESET PASSWORD TAB -->
                                                    <% } -%>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END PROFILE CONTENT -->
                        </div>
                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
    </div>
    <!-- END CONTAINER -->
    <% include _layouts/global_plugin %>
    <% include _layouts/socket %>
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/jquery.sparkline.min.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/assets/pages/scripts/profile.min.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL SCRIPTS -->
    <!-- SELF ADDING SCRIPT -->
    <script type="text/javascript">
        function isSame(){
            var currentPW = document.getElementById("currentPW").value
            var newPW = document.getElementById("newPW").value
            var reNewPW = document.getElementById("reNewPW").value
            var reg = new RegExp(/[\Da-zA-Z0-9]{8,20}/)
            if(currentPW.length == 0 || newPW.length == 0 || reNewPW.length == 0){
                swal("Chú ý", "Vui lòng nhập đủ thông tin!", "warning", {confirmButtonColor: 'orange'})
                return false
            }
            if(!newPW.match(reg)){
                swal("Chú ý", "Mật khẩu mới không đúng định dạng. Mật khẩu phải có độ dài tối thiểu 8 kí tự, có thể chứa chữ cái, chữ số hoặc kí tự đặc biệt", "warning", {confirmButtonColor: 'orange'})
                return false
            }
            if(newPW == reNewPW){
                return true
            }else{
                swal("Chú ý", "Mật khẩu mới nhập lại không khớp", "warning", {confirmButtonColor: 'orange'})
                return false
            }
        }

        function change_pw(){
            if(!isSame()) return

            var formData = new FormData(document.querySelector('#change_pw_form'))

            var submit_data = {}
            
            var data = {}
            for (var pair of formData.entries()) {
                data[pair[0]] = pair[1]
            }

            submit_data.oldPW = data.currentPW
            submit_data.newPW = data.newPW
            swal({
                title: "Chú ý!",
                text: "Bạn chắc chắn muốn thay đổi mật khẩu?",
                dangerMode: true,
                type: "question",
                buttons:{
                    cancel: "Hủy bỏ",
                    confirm: "Tiếp tục"
                },
                showCancelButton: true,
                allowOutsideClick: false
            })
            .then(function(result){
                if(result.value){
                    axios.post("/user/change-password", {
                        headers:{
                            "Content-Type": "application/json"
                        },
                        data: submit_data
                    })
                    .then(function(response){
                        console.log(response)
                        if(response.status == 200){
                            swal("Thành công!", "Mật khẩu của bạn đã được thay đổi", "success", {showConfirmButton: false})
                            setTimeout(function(){
                                location.reload()
                            }, 500)
                        }
                    })
                    .catch(function(error){
                        if(error.response){
                            swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                        }
                    })    
                }
            })
        }

        function add_user(){
            var formData = new FormData(document.getElementById('adding_form'))

            var data = {}
            for (var pair of formData.entries()) {
              data[pair[0]] = pair[1]
            }
            axios.post('/user/register', {
                headers:{
                    'Content-Type': 'application/json'
                },
                data: data
            })
            .then(function(response){
                if(response.status == 200){
                    swal("Thành công!", "Thêm mới người dùng thành công!", "success", {showConfirmButton: false})
                }
            })
            .catch(function(error){
                console.error(error)
                error_alert()
                // swal("Đã có lỗi", error.response, "error", {confirmButtonColor: 'red'})
            })
        }

        function reset_pw(){
            var username = document.querySelector('#reset_form #username').value
            if(!username){
                swal("Chú ý!", "Điền ít nhất một tên tài khoản để tiếp tục!", "info")
                return
            }
            swal({
                title: "Xác nhận",
                text: "Reset mật khẩu người dùng này về mặc định?", 
                showCancelButton: true,
                confirmButtonText: "Tiếp tục",
                cancelButtonText: "Hủy bỏ",
                confirmButtonColor: 'orange',
                type: "warning",
                allowOutsideClick: false
            })
            .then(function(result){
                if(result.value){
                    axios.post(`/user/forgotpw`, {
                        headers:{
                            'Content-Type': 'application/json'
                        },
                        data: username
                    }).then(function(res){
                        if(res.status == 200){
                            swal("Thành công!", "Đã reset mật khẩu người dùng về mặc định!", "success")
                        }
                    }).catch(function(error){
                        console.error(error)
                        swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                    })
                }
            })
        }
    </script>
    <!-- END OF SELF ADDING SCRIPT -->
<% include _layouts/footer %>
<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/assets/apps/css/inbox.min.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Chi tiết ticket 
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                    <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="profile-content">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="portlet light bordered">
                                    <div class="portlet-title tabbable-line">
                                        <div class="caption caption-md">
                                            <i class="icon-globe theme-font hide"></i>
                                            <span class="caption-subject font-blue-madison bold uppercase">Ticket no.<%= ticket.id %></span>
                                        </div>
                                        <ul class="nav nav-tabs">
                                            <li class="active">
                                                <a href="#tab_1_1" data-toggle="tab">Thông tin ticket</a>
                                            </li>
                                            <li>
                                                <a href="#tab_1_2" data-toggle="tab">Thay đổi thông tin ticket</a>
                                            </li>
                                            <li>
                                                <a href="#tab_1_3" data-toggle="tab">Lịch sử chỉnh sửa</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="portlet-body">
                                        <div class="tab-content">
                                            <!-- TICKET INFO TAB -->
                                            <div class="tab-pane active" id="tab_1_1">
                                                <div class="mt-element-step">
                                                    <div class="row step-line col-md-12">
                                                        <div class="mt-step-desc">
                                                            <div class="font-dark bold uppercase">Trạng thái hoàn thành
                                                            </div>
                                                        </div>
                                                        <div class="col-md-offset-1 col-md-2 mt-step-col first <% if ( ticket.status == 'new' ) { -%>
                                                                active
                                                            <% } else { -%>
                                                                done
                                                            <% } -%>">
                                                            <div class="mt-step-number bg-white">1
                                                            </div>
                                                            <div class="mt-step-title uppercase font-grey-cascade">Init
                                                            </div>
                                                            <div class="mt-step-content font-grey-cascade">Hệ thống nhận được ticket
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2 mt-step-col <% if ( ticket.status == 'assigned' ) { -%>
                                                                active
                                                            <% } else { -%>
                                                                <% if (ticket.status == 'new') { -%>
                                                                    
                                                                <% } else { -%>
                                                                    done
                                                                <% } -%>
                                                            <% } -%>">
                                                            <div class="mt-step-number bg-white">2
                                                            </div>
                                                            <div class="mt-step-title uppercase font-grey-cascade">Assigned
                                                            </div>
                                                            <div class="mt-step-content font-grey-cascade">Admin/supervisor chỉ định người trả lời ticket
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2 mt-step-col <% if ( ticket.status == 'recieved' ) { -%>
                                                                active
                                                            <% } else { -%>
                                                                <% if (ticket.status == 'new' || ticket.status == 'assigned') { -%>
                                                                    
                                                                <% } else { -%>
                                                                    done
                                                                <% } -%>
                                                            <% } -%>">
                                                            <div class="mt-step-number bg-white">3
                                                            </div>
                                                            <div class="mt-step-title uppercase font-grey-cascade">Recieved
                                                            </div>
                                                            <div class="mt-step-content font-grey-cascade">Người được chỉ định xác nhận đã nhận được ticket
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2 mt-step-col <% if ( ticket.status == 'resolved' ) { -%>
                                                                active
                                                            <% } else { -%>
                                                                <% if (ticket.status == 'closed') { -%>
                                                                    done
                                                                <% } else { -%>
                                                                    
                                                                <% } -%>
                                                            <% } -%>">
                                                            <div class="mt-step-number bg-white">4</div>
                                                            <div class="mt-step-title uppercase font-grey-cascade">Resolved</div>
                                                            <div class="mt-step-content font-grey-cascade">Người được chỉ định xác nhận đã xử lý xong ticket</div>
                                                        </div>
                                                        <div class="col-md-2 mt-step-col last <% if ( ticket.status == 'closed' ) { -%>
                                                                active
                                                            <% } -%>">
                                                            <div class="mt-step-number bg-white">5</div>
                                                            <div class="mt-step-title uppercase font-grey-cascade">Closed</div>
                                                            <div class="mt-step-content font-grey-cascade">Admin/supervisor xác nhận ticket đã được xử lý, đóng yêu cầu xử lý</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Ticket ID</p>
                                                            <p class="col-md-8"><%= ticket.id %></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Loại</p>
                                                            <p class="col-md-8"><%= ticket.type %></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Assignee</p>
                                                            <p class="col-md-8"><%= ticket.assignee %></p>
                                                        </div>  
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Member code</p>
                                                            <p class="col-md-8"><%= ticket.member_profile.member_code %></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Member link chat</p>
                                                            <a class="col-md-8" style="text-decoration: none;" href=<%= ticket.member_profile.fb_linkChat%> > <%= ticket.member_profile.fb_linkChat%> </a>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Member's facebook ID</p>
                                                            <p class="col-md-8"><%= ticket.member_profile.fb_id%></p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Thời gian khởi tạo</p>
                                                            <p class="col-md-8"><%= ticket.create_time %></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Cập nhật gần nhất bởi</p>
                                                            <p class="col-md-8"><% if (ticket.assignee) { -%>
                                                                <%= ticket.assignee %>
                                                            <% } else { -%>
                                                                -
                                                            <% } -%></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Cập nhật gần nhất vào lúc</p>
                                                            <p class="col-md-8"><% if (ticket.update_time) { -%>
                                                                <%= ticket.update_time %>
                                                            <% } else { -%>
                                                                -
                                                            <% } -%></p>
                                                        </div>
                                                        <div class="ticket_info row col-md-12">
                                                            <p class="col-md-4" style="font-weight: bold;">Thời gian hoàn thành</p>
                                                            <p class="col-md-8"><% if (ticket.finish_time) { -%>
                                                                <%= ticket.finish_time %>
                                                            <% } else { -%>
                                                                -
                                                            <% } -%></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- END TICKET INFO TAB -->
                                            <!-- TICKET CHANGE INFO TAB -->
                                            <div class="tab-pane" id="tab_1_2">
                                                <form role="form" class="form-horizontal" action="#" id="change_ticket_info" data-ticket = <%= ticket.id %>>
                                                    <div class="form-body">
                                                        <div class="form-group">
                                                            <label class="col-md-3 control-label">Độ ưu tiên</label>
                                                            <div class="col-md-4">
                                                                <select class="form-control" id="priority" name="priority">
                                                                        <option value="normal" <% if (ticket.priority == 'normal') { -%>
                                                                            selected
                                                                        <% } -%>>Bình thường</option>
                                                                        <option value="high" <% if (ticket.priority == 'high') { -%>
                                                                            selected
                                                                        <% } -%>>Cao</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="control-label col-md-3">Trạng thái</label>
                                                            <div class="col-md-4">
                                                                <select class="form-control" id="select_status" name="status">
                                                                    <option value="new" <% if (ticket.status == 'new') { -%>
                                                                            selected
                                                                        <% } -%>>New
                                                                    </option>
                                                                    <option value="assigned" <% if (ticket.status == 'assigned') { -%>
                                                                            selected
                                                                        <% } -%>>Assigned
                                                                    </option>
                                                                    <option value="recieved" <% if (ticket.status == 'recieved') { -%>
                                                                            selected
                                                                        <% } -%> disabled>Recieved
                                                                    </option>
                                                                    <option value="resolved" <% if (ticket.status == 'resolved') { -%>
                                                                            selected
                                                                        <% } -%>>Resolved
                                                                    </option>
                                                                    <option value="closed" <% if (ticket.status == 'closed') { -%>
                                                                            selected
                                                                        <% } -%>
                                                                        <% if (user.role == 'user') { -%>
                                                                            hidden
                                                                        <% } -%>
                                                                        >Closed
                                                                    </option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="control-label col-md-3">Assign to</label>
                                                            <div class="col-md-4">
                                                                <% if (ticket.status != 'new' || user.role == 'user' || ticket.assignee != "") { -%>
                                                                    <select name="assignee" class="form-control" id="select_assignee" disabled>
                                                                        <% for (var i = 0; i < users.length ; i++) { -%>
                                                                            <option value="<%= users[i].username%>" <% if (users[i].username == ticket.assignee) { -%>
                                                                                    selected
                                                                            <% } -%>> <%= users[i].username %> </option>
                                                                        <% } -%>
                                                                    </select>    
                                                                <% } else { -%>
                                                                    <select name="assignee" class="form-control" id="select_assignee">
                                                                        <option hidden>-Select one from list-</option>
                                                                        <% for (var i = 0; i < users.length ; i++) { -%>
                                                                            <option value="<%= users[i].username%>" > <%= users[i].username%> </option>
                                                                        <% } -%>
                                                                    </select>    
                                                                <% } -%>
                                                            </div> 
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="control-label col-md-3">Comment</label>
                                                            <div class="col-md-4">
                                                                <textarea name="comment" form="change_ticket_info" style="width: 100%;"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-actions">
                                                        <div class="row">
                                                            <div class="col-md-offset-3 col-md-9">
                                                                <button id="save_change" type="button" onclick="updateTicket()" class="btn green">Lưu thay đổi</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                            <!-- END TICKET HISTORY TAB -->
                                            <!-- TICKET HISTORY TAB -->
                                            <div class="tab-pane" id="tab_1_3">
                                                <div class="mt-comments">
                                                    <% for (var i = 0; i < history.length; i++) { -%>
                                                    <div class="mt-comment">
                                                        <div class="mt-comment-img">
                                                            <img src="/assets/pages/media/users/avatar1.jpg" /> </div>
                                                        <div class="mt-comment-body">
                                                            <div class="mt-comment-info">
                                                                <span class="mt-comment-author"><%= history[i].update_by %></span>
                                                                <span class="mt-comment-date"><%= history[i].update_time %></span>
                                                            </div>
                                                            <% if (history[i].change_description.comment) { -%>
                                                                <div class="mt-comment-text" style="font-style: italic;"> "<%= history[i].change_description.comment %>" </div>
                                                            <% } -%>
                                                            <div class="mt-comment-details">
                                                                <span class="mt-comment-status mt-comment-status-pending"><%= history[i].update_by%> đã update <% for (var j = 0; j < history[i].change_description.content.length; j++) { -%>
                                                                    ticket <%= history[i].change_description.content[j].field %> thành <%= history[i].change_description.content[j].value %>.
                                                                <% } -%></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } -%>
                                                </div>
                                            </div>
                                            <!-- END TICKET HISTORY TAB -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
    </div>
    <!-- END CONTAINER -->
    <% include _layouts/global_plugin %>
    <!-- SELF ADDING SCRIPT -->
    <!-- END OF SELF ADDING SCRIPT -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/assets/pages/scripts/table-datatables-managed.js" type="text/javascript"></script>
    <script type="text/javascript">
        function get_original_info(){
            var formData = new FormData(document.getElementById('change_ticket_info'))
            var id = document.getElementById('change_ticket_info').getAttribute('data-ticket')
            var data = {}
            for (var pair of formData.entries()) {
                data[pair[0]] = (pair[1] == 'N/A' || pair[1] == "")?"":pair[1]
            }   
            return data
        }

        const orignal = get_original_info()

        var select_assignee = document.getElementById('select_assignee')
        select_assignee.addEventListener('change', function(){
            if(this.value){
                document.getElementById('select_status').value = 'assigned'
            }
        })
        console.log(orignal)
        function updateTicket(){
            var formData = new FormData(document.getElementById('change_ticket_info'))
            var id = document.getElementById('change_ticket_info').getAttribute('data-ticket')
            var data = {}
            var test_data = {}
            for (var pair of formData.entries()){
                test_data[pair[0]] = (pair[1] == 'N/A' || pair[1] == "")?"":pair[1]
            }
            for (var pair of formData.entries()) {
                if(pair[1] != orignal[pair[0]]){
                    data[pair[0]] = (pair[1] == 'N/A' || pair[1] == "")?"":pair[1]
                }
            }   
            console.log(data)
            if(deepCompare(orignal, test_data)){
                swal("Chú ý!", "Dữ liệu không thay đổi!", "warning")
                return
            }

            swal({
                title: "Xác nhận",
                text: "Cập nhật ticket?", 
                showCancelButton: true,
                confirmButtonText: "Tiếp tục",
                cancelButtonText: "Hủy bỏ",
                confirmButtonColor: 'orange',
                type: "warning",
                allowOutsideClick: false
            })
            .then(function(result){
                if(result.value){
                    axios.post(`/manager/ticket/update/${id}`, {
                        headers:{
                            'Content-Type': 'application/json'
                        },
                        data: data
                    }).then(function(res){
                        if(res.status == 200){
                            swal("Thành công!", "Thay đổi dữ liệu thành công!", "success", {showConfirmButton: false})
                            setTimeout(function(){
                                location.reload()
                            }, 500)
                        }
                    }).catch(function(error){
                        console.error(error)
                        swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                    })
                }
            })
        }
        function deepCompare () {
          var i, l, leftChain, rightChain;

          function compare2Objects (x, y) {
            var p;

            if (isNaN(x) && isNaN(y) && typeof x === 'number' && typeof y === 'number') {
                 return true;
            }

            if (x === y) {
                return true;
            }

            if ((typeof x === 'function' && typeof y === 'function') ||
               (x instanceof Date && y instanceof Date) ||
               (x instanceof RegExp && y instanceof RegExp) ||
               (x instanceof String && y instanceof String) ||
               (x instanceof Number && y instanceof Number)) {
                return x.toString() === y.toString();
            }

            // At last checking prototypes as good as we can
            if (!(x instanceof Object && y instanceof Object)) {
                return false;
            }

            if (x.isPrototypeOf(y) || y.isPrototypeOf(x)) {
                return false;
            }

            if (x.constructor !== y.constructor) {
                return false;
            }

            if (x.prototype !== y.prototype) {
                return false;
            }

            // Check for infinitive linking loops
            if (leftChain.indexOf(x) > -1 || rightChain.indexOf(y) > -1) {
                 return false;
            }

            for (p in y) {
                if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
                    return false;
                }
                else if (typeof y[p] !== typeof x[p]) {
                    return false;
                }
            }

            for (p in x) {
                if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {
                    return false;
                }
                else if (typeof y[p] !== typeof x[p]) {
                    return false;
                }

                switch (typeof (x[p])) {
                    case 'object':
                    case 'function':

                        leftChain.push(x);
                        rightChain.push(y);

                        if (!compare2Objects (x[p], y[p])) {
                            return false;
                        }

                        leftChain.pop();
                        rightChain.pop();
                        break;

                    default:
                        if (x[p] !== y[p]) {
                            return false;
                        }
                        break;
                }
            }

                return true;
              }

              if (arguments.length < 1) {
                return true; //Die silently? Don't know how to handle such case, please help...
                // throw "Need two or more arguments to compare";
              }

              for (i = 1, l = arguments.length; i < l; i++) {

                  leftChain = []; //Todo: this can be cached
                  rightChain = [];

                  if (!compare2Objects(arguments[0], arguments[i])) {
                      return false;
                  }
              }

              return true;
        }
    </script>
    <!-- END PAGE LEVEL SCRIPTS -->
<% include _layouts/footer %>
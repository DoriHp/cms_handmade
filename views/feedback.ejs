<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/assets/apps/css/inbox.min.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Quản lý phản hồi từ người dùng
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                     <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="inbox">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="inbox-sidebar">
                                    <ul class="inbox-nav">
                                        <li class="active">
                                            <a href="javascript:;" onclick="request_feedback_list(this)" data-type="all" data-title="Inbox"> Tất cả
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" onclick="request_feedback_list(this)" data-type="unread" data-title="Inbox">Chưa xem
                                                <span class="badge badge-warning" id="num_of_unread"></span>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" onclick="request_feedback_list(this)" data-type="unreply" data-title="Draft"> Chưa trả lời
                                                <span class="badge badge-danger" id="num_of_unreply"></span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-12">
                                        <!-- BEGIN SAMPLE TABLE PORTLET-->
                                        <div class="portlet box red">
                                            <div class="portlet-title">
                                                <div class="caption">
                                                    <i class="far fa-list-alt"></i>Feedback</div>
                                                <div class="tools" style="margin-left: 10px;" style="align-content: right">
                                                    <a class="collapse"> </a>
                                                </div>
                                                <div class="actions" style="align-content: left">
                                                    <!-- <button type="button" class="btn btn-default btn-sm">
                                                        <i class="far fa-check-circle"></i></i> Mark as important </button> -->
                                                    <button type="button" class="btn btn-default btn-sm" onclick="open_chat()">
                                                        <i class="far fa-edit"></i> Viết trả lời </button>
                                                </div>
                                            </div>
                                            <div class="portlet-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1_2">
                                                        <thead>
                                                            <tr>
                                                                <th>
                                                                    <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                                    <input type="checkbox" class="checkboxes" value="1" disabled />
                                                                    <span></span>
                                                                    </label>
                                                                </th>
                                                                <th> Facebook ID </th>
                                                                <th> Loại phản hồi </th>
                                                                <th> Thời gian gửi </th>
                                                                <th> Trạng thái </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                                <% for (var i = 0; i < feedbacks.length ; i++) { -%>
                                                                	<tr class="odd gradeX" id="<%= feedbacks[i]._id %>">
	                                                                    <td>
	                                                                        <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
	                                                                            <input type="checkbox" class="checkboxes" value="<%= feedbacks[i]._id %>|<%= feedbacks[i].fb_id %>"/>
	                                                                            <span></span>
	                                                                        </label>
	                                                                    </td>
	                                                                    <td> <%= feedbacks[i].fb_id %> </td>
	                                                                    <td> <%= feedbacks[i].type %> </td>
	                                                                    <td> <%= feedbacks[i].time %> </td>
                                                                        <td> 
                                                                            <% if (feedbacks[i].status.read) { -%>
                                                                                <span class="label label-sm label-success label-feedback"> Đã đọc </span>
                                                                            <% } else { -%>
                                                                                <span class="label label-sm label-warning label-feedback"> Chưa đọc </span>
                                                                            <% } -%>
                                                                            <% if (feedbacks[i].status.reply) { -%>
                                                                                <span class="label label-sm label-info label-feedback"> Đã trả lời </span>
                                                                            <% } else { -%>
                                                                                <span class="label label-sm label-danger label-feedback"> Chưa trả lời </span>
                                                                            <% } -%> 
                                                                        </td>
                                                                	</tr>
                                                                <% } -%>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END SAMPLE TABLE PORTLET-->
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="feedback_area" style="display: none;">
                    	<div class="col-md-6">
                    		<div class="portlet box red">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fas fa-info-circle"></i> Thông tin người dùng 
                                    </div>
                                    <div class="tools">
                                        <a href="" class="collapse"> </a>
                                    </div>
                                </div>
                                <div class="portlet-body user_profile">
                                    <div id="user_avatar">
                                        <img alt="User's avatar">
                                        <p></p>
                                    </div>
                                    <div id="user_info">
                                        <p>Facebook id: <span></span></p>
                                        <p>Facebook name: <span></span></p>
                                        <p>Giới tính: <span></span></p>
                                        <p>Quốc gia: <span></span></p>
                                        <p>Cho phép bot tự động trả lời người dùng này:  <span></span></p>
                                    </div>
                                </div>
                            </div>
                    	</div>
                    	<div class="col-md-6" id="preview-div">
							<ul>
							</ul>
                        </div>
                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <div id="myModal" class="modal">
                <i class="far fa-times-circle close-modal"></i>
                <img class="modal-content" id="img01">
                <div id="caption"></div>
            </div>
    </div>
    <!-- END CONTAINER -->
    <% include _layouts/global_plugin %>
    <!-- SELF ADDING SCRIPT -->
    <script type="text/javascript">
        var list_checked = []
        const nav_ul = document.getElementsByClassName('inbox-nav')[0]
        const nav_li = nav_ul.querySelectorAll('li')
        const feedback_content = document.getElementById('preview-div')
        const feedback_area = document.getElementById('feedback_area')
        for(let i of nav_li){
            i.addEventListener('click', active)
        }

        function add_listener(){
            var feedback_row = document.querySelectorAll('#sample_1_2 tbody tr')
            for(let i of feedback_row){

                i.addEventListener('click', get_feedback)
                var j = i.querySelectorAll('td')[0]
                $(j).add(i).click(handler)
                j.addEventListener('click', add_to_list)
            }
        }

        add_listener()
        function handler(event) {
            event.stopPropagation()
        }

        function customize_table(scope){
            var table = document.getElementById('sample_1_2')
            var wrapper = document.getElementById('sample_1_2_wrapper')
            if(scope != 'all'){
                table.querySelectorAll('thead tr th').forEach(th => th.style.pointerEvents = "none")
                table.classList.remove('dataTable')
                wrapper.querySelectorAll('div').forEach(div => {
                    if(!div.classList.contains('table-scrollable')) div.style.display = 'none'
                })
            }else{
                table.querySelectorAll('thead tr th').forEach(th => th.style.pointerEvents = "auto")
                wrapper.querySelectorAll('div').forEach(div => {
                    if(!div.classList.contains('table-scrollable')) div.style.display = 'block'
                })
                if(!table.classList.contains('dataTable')) table.classList.add('dataTable')
            }
        }

        //tải feedback list dựa trên read and reply fields
        function request_feedback_list(e){
            var scope = e.getAttribute('data-type')
            axios.get('/manager/feedback/list/' + scope)
            .then(function(response){
                if(response.status == 200){
                    customize_table(scope)    
                    display_feedback_list(response.data)
                }else{
                    alert("Lỗi khi tải dữ liệu!")
                }
            })
            .catch(function(error){
                console.log(error)
                alert("Đã có lỗi xảy ra!")
            })
        }

        function display_feedback_list(data){
            var table_body = document.querySelector('#sample_1_2 tbody')
            while (table_body.firstChild) {
                table_body.removeChild(table_body.firstChild);
            }
            var index = 0
            for(let i of data){
                let row = table_body.insertRow(index)
                row.id = i._id
                
                var cell0 = row.insertCell(0)
                var cell1 = row.insertCell(1)
                var cell2 = row.insertCell(2)
                var cell3 = row.insertCell(3)
                var cell4 = row.insertCell(4)

                cell0.innerHTML = `<label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                        <input type="checkbox" class="checkboxes" value="${i._id}|${i.fb_id}">
                                        <span></span>
                                    </label>`
                cell1.innerHTML = i.fb_id
                cell2.innerHTML = i.type
                cell3.innerHTML = i.datetime
                if(i.status.read && i.status.reply){
                    cell4.innerHTML = '<span class="label label-sm label-success label-feedback"> Đã đọc </span>'
                    + '<span class="label label-sm label-info label-feedback"> Đã trả lời </span>'
                }else if(!i.status.read && !i.status.reply){
                    cell4.innerHTML = '<span class="label label-sm label-warning label-feedback"> Chưa đọc </span>'
                    + '<span class="label label-sm label-danger label-feedback"> Chưa trả lời </span>'
                }else if(i.status.read && !i.status.reply){
                    cell4.innerHTML = '<span class="label label-sm label-success label-feedback"> Đã đọc </span>'
                    + '<span class="label label-sm label-danger label-feedback"> Chưa trả lời </span>'
                }
                index++
            }
            add_listener()
        }

        //hiển thị tin nhắn text
        function display_text_message(ul, from ,text ){
            var li = document.createElement('li')
            li.innerHTML = text
            li.classList.add(from)
            ul.appendChild(li)
        }

        //hiển thị tin nhắn hình ảnh
        function display_image_message(ul, from, url){

            var img = document.createElement('img')
            img.src = url
            img.classList.add(from)
            img.addEventListener('click', zoom)
            ul.appendChild(img)
        }

        //hiển thị tin nhắn đính kèm file (khác img)
        function display_file_message(ul, from, url){

            var li = document.createElement('li')
            li.classList.add(from)
            li.innerHTML = url
            ul.appendChild(li)
        }

        //hiển thị fb template button type
        function display_template_button(ul, from, data){
            var container = document.createElement('div')
            container.classList.add('button_template', from)
            var title = document.createElement('div')
            title.classList.add('btn_template_title')
            title.innerHTML = data.text
            container.appendChild(title)
            var btn_group = document.createElement('div')
            btn_group.classList.add('btn_group')
            for(let i of data.buttons){
                let button = document.createElement('button')
                button.innerHTML = i.title
                btn_group.appendChild(button)
            }
            container.appendChild(btn_group)
            ul.appendChild(container)
        }

        //lấy dữ liệu về một feedback
        function get_feedback(e){
            get_user_info(this.id)
            axios.get(`/manager/feedback/read/${encodeURIComponent(this.id)}`)
            .then(function(response){
                if(response.status == 200){
                    display_feedback(response.data)
                }
            })
            .catch(function(error){
                console.error(error)
                swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
            })
        }

        //hiển thị dữ liệu về một feedback
        function display_feedback(data){
            var feedback_ul = document.querySelector('#preview-div ul')
            while (feedback_ul.firstChild) {
                feedback_ul.removeChild(feedback_ul.firstChild);
            }
            for(let i of data.feedbacks){
                if(i.from == 'member'){
                    if(i.text || i.postback){
                        display_text_message(feedback_ul, 'him', i.text || i.postback.title)
                    if(i.attachments && i.attachments[0].type == 'image')
                        display_image_message(feedback_ul, 'him', i.attachments[0].payload.url)
                    }
                    if(i.attachments && i.attachments[0].type == 'file'){
                        display_file_message(feedback_ul, 'him', i.attachments[0].payload.url)
                    }
                }else if(i.from == 'fanpage'){
                    if(i.text){
                        display_text_message(feedback_ul, 'me', i.text)
                    }
                    if(i.attachments && i.attachments[0].type == 'image'){
                        display_image_message(feedback_ul, 'me', i.attachments[0].payload.url)
                    }
                    if(i.attachments && i.attachments[0].type == 'file'){
                        display_file_message(feedback_ul, 'me', i.attachments[0].payload.url)
                    }
                    if(i.attachment && i.attachment.type == 'template'){
                        display_template_button(feedback_ul, 'me', i.attachment.payload)
                    }
                }else{
                    if(i.text){
                        display_text_message(feedback_ul, 'bot', i.text)
                    }
                    if(i.attachments && i.attachments[0].type == 'image'){
                        display_image_message(feedback_ul, 'bot', i.attachments[0].payload.url)
                    }
                    if(i.attachments && i.attachments[0].type == 'file'){
                        display_file_message(feedback_ul, 'bot', i.attachments[0].payload.url)
                    }
                    if(i.attachment && i.attachment.type == 'template'){
                        display_template_button(feedback_ul, 'bot', i.attachment.payload)
                    }
                }
            }
            feedback_area.style.display = 'block'
            scrollTo(document.body, document.getElementById('preview-div'), 200)
            axios.post('/manager/feedback/update/' + encodeURIComponent(data._id),{
                headers: {
                    'Content-Type': 'application/json'
                },
                data:{'status.read': true}
            })
            .then(function(response){
                if(response.status == 200){
                    console.log('Updated feedback status')
                }
            })
            .catch(function(error){
                console.log('Failed to update feedback status! \n' + error)
            })

        }

        //thêm feedback được đánh dấu trong checkbox
        function add_to_list(e){
            var checkbox = this.querySelector('label input')
            var spliter = checkbox.value.split('|')
            var data = {
                _id: spliter[0],
                fb_id: spliter[1]
            }
            if(checkbox.checked && list_checked.indexOf(data) == -1){
                list_checked.push(data)
            }else{
                let index = list_checked.indexOf(data)
                if (index > -1) {
                  list_checked.splice(index, 1)
                }
            }
        }

        //thay đổi mục được chọn
        function active(e){
            for(let i of nav_li){
                i.classList.remove('active')
            }                
            this.classList.add('active')
        }

        //lấy dữ liệu về người dùng
        function get_user_info(fb_id){
            var display = document.getElementById('user_info')
            var span = user_info.querySelectorAll('span')
            var img = document.querySelector('#user_avatar img')
            axios.get('/manager/feedback/user_info/' + encodeURIComponent(fb_id))
            .then(function(response){
                if(response.status == 200){
                    var data = []
                    var res = response.data
                    img.setAttribute('src', res.profile_pic)
                    data.push(res.id)
                    data.push(res.first_name + " " + res.last_name)
                    data.push((res.gender == 'male')?'Name':'Nữ')
                    data.push(res.locale)
                    data.push(res.auto_reply)
                    for(let i in data){
                        if(i != 4){
                            span[i].innerHTML = data[i]
                        }else{
                            if(data[i]){
                                span[i].innerHTML = `<label class="switch"><input id=${res.id} class="input_status" type="checkbox" checked><span class="slide round"></span></label>`
                            }else{
                                span[i].innerHTML = `<label class="switch"><input id=${res.id} class="input_status" type="checkbox"><span class="slide round"></span></label>`
                            }
                        }
                    }
                    document.getElementsByClassName('input_status')[0].addEventListener('click', change_auto_reply)
                }
            })
            .catch(function(error){
                console.error(error)
                while (display.firstChild) {
                    display.removeChild(display.firstChild)
                    var p = document.createElement('p')
                    p.innerHTML = 'Đã có lỗi xảy ra, không thể hiển thị dữ liệu người dùng!'
                    display.appendChild(p)
                }
            })
        }

        //mở fb chat link và thay đổi trạn thái cho phép trả lời của bot
        function open_chat(){
            if(list_checked.length == 0){
                swal("Chú ý", "Chọn ít nhất một phản hồi để mở cửa sổ chat!", "info")
                return
            }
            if(list_checked.length >= 1){
                for(let i of list_checked){
                    axios.get('/manager/feedback/user_link/' + encodeURIComponent(i.fb_id))
                    .then(function(response){
                        if(response.status == 200){
                            var child = window.open(response.data, '_blank')
                            var pre 
                            axios.post('/manager/feedback/user_info/' + encodeURIComponent(i.fb_id),
                            {
                                headers:{
                                    'Content-Type': 'application/json'
                                },
                                data: {auto_reply: false}
                            })
                            .catch(function(error){
                                console.error(error)
                                swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                            })
                            var timer = setInterval(checkChild, 500)

                            function checkChild() {
                                if (child.closed) {
                                    axios.post('/manager/feedback/user_info/' + encodeURIComponent(i.fb_id),
                                    {
                                        headers:{
                                            'Content-Type': 'application/json'
                                        },
                                        data: {auto_reply: true}
                                    }).catch(function(error){
                                        console.error(error)
                                    })
                                    clearInterval(timer)
                                }
                            }

                            function update_status_feedback(){
                                axios.post('/manager/feedback/update/' + encodeURIComponent(i._id),{
                                    headers:{
                                        'Content-Type': 'application/json'
                                    },
                                    data: {status: {
                                        read: true,
                                        reply: true
                                    }}
                                })
                                .then(function(response){
                                    if(response.status == 200) console.log('Changed feedback stauts to replied')
                                })
                                .catch(function(error){
                                    console.error('Failed to change feedback status' + error)
                                    return
                                })
                            }

                            update_status_feedback()
                        }
                        else{
                            swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                            return
                        }
                    })
                    .catch(function(error){
                        console.error(error)
                        swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                    })
                }
            }
            
        }

        //đổi trạng thái cho phép bot trả lời user
        function change_auto_reply(e){
            var status = (this.checked)?true:false
            axios.post('/manager/feedback/user_info/' + encodeURIComponent(this.id), {
                headers:{
                    "Content-Type": "application/json"
                },
                data: {auto_reply: status}
            })
            .then(function(response){
                if(response.status == 200)
                swal( "Thành công!", "Đã thay đổi trạng thái cho phép bot trả lời người dùng!", "success", {confirmButtonColor: 'green'})
            })
            .catch(function(error){
                console.error(error)
                swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
            })
        }

        function change_num(){
            var table = document.getElementById('sample_1_2')
            var num_of_unread = table.querySelectorAll('.label-warning').length
            var num_of_unreply = table.querySelectorAll('.label-danger').length
            document.getElementById('num_of_unread').innerHTML = (num_of_unread == 0)?"":num_of_unread
            document.getElementById('num_of_unreply').innerHTML = (num_of_unreply == 0)?"":num_of_unreply
        }

        change_num()
        function scrollTo(element, to, duration) {
            if (duration <= 0) return
            var difference = to - element.scrollTop
            var perTick = difference / duration * 10

            setTimeout(function() {
                element.scrollTop = element.scrollTop + perTick
                if (element.scrollTop === to) return
                scrollTo(element, to, duration - 10)
            }, 10)
        }

    </script>
    <script>
        //phóng to hình ảnh trong phần đọc feedback
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var modalImg = document.getElementById("img01");
        var captionText = document.getElementById("caption");
        function zoom(e){
          modal.style.display = "block"
          modalImg.src = this.src
          captionText.innerHTML = this.alt
        }

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close-modal")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
          modal.style.display = "none";
        }
    </script>
    <script type="text/javascript">
        socket.on('update feedback', function(data){   
            var row = document.getElementById(data.feedback._id)
            var labels = row.querySelectorAll('.label-feedback')
            if(data.feedback.status.read){
                labels[0].innerHTML = 'Đã đọc'
                labels[0].classList.remove('label-warning')
                labels[0].classList.add('label-success')
            }
            if(data.feedback.status.reply){
                labels[1].innerHTML = 'Đã trả lời'
                labels[1].classList.remove('label-danger')
                labels[1].classList.add('label-info')   
            }
            change_num()
        })
    </script>  
    <!-- END OF SELF ADDING SCRIPT -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/assets/pages/scripts/table-datatables-managed.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL SCRIPTS -->
<% include _layouts/footer %>
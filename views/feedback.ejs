<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/assets/apps/css/inbox.min.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Quản lý phản hồi từ người dùng
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                        <% include _layouts/toolbar %>
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                     <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="inbox">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="inbox-sidebar">
                                    <ul class="inbox-nav">
                                        <li class="active">
                                            <a href="javascript:;" data-type="inbox" data-title="Inbox"> Tất cả
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" data-type="important" data-title="Inbox">Chưa đọc
                                                <span class="badge badge-danger" id="num_of_unread">1</span>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" data-type="draft" data-title="Draft"> Trạng thái
                                                <span class="badge badge-danger" id="num_of_replied"></span>
                                            </a>
                                        </li>
                                        <li class="divider"></li>
                                        <li>
                                            <a href="javascript:;" data-type="inbox" data-title="Promotions">Quan trọng
                                                <span class="badge badge-warning">2</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-12">
                                        <!-- BEGIN SAMPLE TABLE PORTLET-->
                                        <div class="portlet box red">
                                            <div class="portlet-title">
                                                <div class="caption">
                                                    <i class="far fa-list-alt"></i>Feedback</div>
                                                <div class="actions" style="align-content: left">
                                                    <button type="button" class="btn btn-default btn-sm">
                                                        <i class="far fa-check-circle"></i></i> Mark as important </button>
                                                    <button type="button" class="btn btn-default btn-sm">
                                                        <i class="far fa-edit"></i> Viết trả lời </button>
                                                </div>
                                                <div class="tools" style="margin-right: 10px;" style="align-content: right">
                                                    <a class="collapse"> </a>
                                                    <a class="reload"> </a>
                                                </div>
                                            </div>
                                            <div class="portlet-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1_2">
                                                        <thead>
                                                            <tr>
                                                                <th>
                                                                    <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                                    <input type="checkbox" class="checkboxes" value="1" disabled />
                                                                    <span></span>
                                                                    </label>
                                                                </th>
                                                                <th> Facebook ID </th>
                                                                <th> Loại phản hồi </th>
                                                                <th> Thời gian gửi </th>
                                                                <th> Trạng thái </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                                <% for (var i = 0; i < feedbacks.length ; i++) { -%>
                                                                	<tr class="odd gradeX" id="<%= feedbacks[i]._id %>">
	                                                                    <td>
	                                                                        <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
	                                                                            <input type="checkbox" class="checkboxes" value="1"/ id="<%= feedbacks[i]._id %>">
	                                                                            <span></span>
	                                                                        </label>
	                                                                    </td>
	                                                                    <td> <%= feedbacks[i].fb_id %> </td>
	                                                                    <td> <%= feedbacks[i].type %> </td>
	                                                                    <td> <%= feedbacks[i].time %> </td>
                                                                        <td> 
                                                                            <% if (feedbacks[i].status.read) { -%>
                                                                                <span class="label label-sm label-success label-feedback"> Đã đọc </span>
                                                                            <% } else { -%>
                                                                                <span class="label label-sm label-warning label-feedback"> Chưa đọc </span>
                                                                            <% } -%>
                                                                            <% if (feedbacks[i].status.reply) { -%>
                                                                                <span class="label label-sm label-info label-feedback"> Đã trả lời </span>
                                                                            <% } else { -%>
                                                                                <span class="label label-sm label-danger label-feedback"> Chưa trả lời </span>
                                                                            <% } -%> 
                                                                        </td>
                                                                	</tr>
                                                                <% } -%>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END SAMPLE TABLE PORTLET-->
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="feedback_area" style="display: none;">
                    	<div class="col-md-6">
                    		<div class="portlet box red">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fas fa-info-circle"></i> Thông tin người dùng 
                                    </div>
                                    <div class="tools">
                                        <a href="" class="collapse"> </a>
                                    </div>
                                </div>
                                <div class="portlet-body user_profile">
                                    <div id="user_avatar">
                                        <img alt="User's avatar">
                                        <p></p>
                                    </div>
                                    <div id="user_info">
                                        <p>Facebook id: <span></span></p>
                                        <p>Facebook name: <span></span></p>
                                        <p>Giới tính: <span></span></p>
                                        <p>Quốc gia: <span></span></p>
                                    </div>
                                </div>
                            </div>
                    	</div>
                    	<div class="col-md-6" id="preview-div">
							<ul>
							</ul>
                        </div>
                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <div id="myModal" class="modal">
                <i class="far fa-times-circle close-modal"></i>
                <img class="modal-content" id="img01">
                <div id="caption"></div>
            </div>
            <% include _layouts/quick_sidebar %>
    </div>
    <!-- END CONTAINER -->
    <!-- SELF ADDING SCRIPT -->
    <script type="text/javascript">
        var list_checked = []
        const nav_ul = document.getElementsByClassName('inbox-nav')[0]
        const nav_li = nav_ul.querySelectorAll('li')
        const feedback_row = document.querySelectorAll('#sample_1_2 tbody tr')
        const feedback_content = document.getElementById('preview-div')
        const feedback_area = document.getElementById('feedback_area')
        for(let i of nav_li){
            i.addEventListener('click', active)
        }

        for(let i of feedback_row){

            i.addEventListener('click', get_feedback)
        }

        function display_inbox(scope = 'all'){

            if(scope == all){

            }
        }

        //hiển thị tin nhắn text
        function display_text_message(ul, from ,text ){
            var li = document.createElement('li')
            li.innerHTML = text
            if(from == 'member'){
                li.classList.add('him')
            }else{
                li.classList.add('me') 
            }
            ul.appendChild(li)
        }

        //hiển thị tin nhắn hình ảnh
        function display_image_message(ul, from, url){

            var img = document.createElement('img')
            img.src = url
            if(from == 'member'){

                img.classList.add('him')
            }else{

                img.classList.add('me')
            }
            img.addEventListener('click', zoom)
            ul.appendChild(img)
        }

        //hiển thị tin nhắn đính kèm file (khác img)
        function display_file_message(ul, from, url){

            var li = document.createElement('li')
            if(from == 'member'){

                li.classList.add('him')
            }else{

                li.classList.add('me')
            }
            li.innerHTML = url
            ul.appendChild(li)
        }

        //hiển thị fb template button type
        function display_template_button(ul, from, data){
            var container = document.createElement('div')
            container.classList.add('button_template', from)
            var title = document.createElement('div')
            title.classList.add('btn_template_title')
            title.innerHTML = data.text
            container.appendChild(title)
            var btn_group = document.createElement('div')
            btn_group.classList.add('btn_group')
            for(let i of data.buttons){
                let button = document.createElement('button')
                button.innerHTML = i.title
                btn_group.appendChild(button)
            }
            container.appendChild(btn_group)
            ul.appendChild(container)
        }

        function get_feedback(e){
            get_user_info(this.id)
            axios.get(`/manager/feedback/read/${encodeURIComponent(this.id)}`)
            .then(function(response){
                if(response.status == 200){
                    display_feedback(response.data)
                }else{
                    alert('Đã có lỗi xảy ra, vui lòng thử lại sau!')
                    return
                }
            })
            .catch(function(error){
                alert('Tải dữ liệu thất bại, vui lòng thử lại sau!' + error)
            })
        }

        function display_feedback(data){
            var feedback_ul = document.querySelector('#preview-div ul')
            while (feedback_ul.firstChild) {
                feedback_ul.removeChild(feedback_ul.firstChild);
            }
            for(let i of data.feedbacks){
                if(i.from == 'member'){
                    if(i.text || i.postback){
                        display_text_message(feedback_ul, 'member', i.text || i.postback.title)
                    if(i.attachments && i.attachments[0].type == 'image')
                        display_image_message(feedback_ul, 'member', i.attachments[0].payload.url)
                    }
                    if(i.attachments && i.attachments[0].type == 'file'){
                        display_file_message(feedback_ul, 'member', i.attachments[0].payload.url)
                    }
                }else{
                    if(i.text){
                        display_text_message(feedback_ul, 'me', i.text)
                    }
                    if(i.attachments && i.attachments[0].type == 'image'){
                        display_image_message(feedback_ul, 'me', i.attachments[0].payload.url)
                    }
                    if(i.attachments && i.attachments[0].type == 'file'){
                        display_file_message(feedback_ul, 'me', i.attachments[0].payload.url)
                    }
                    if(i.attachment && i.attachment.type == 'template'){
                        display_template_button(feedback_ul, 'me', i.attachment.payload)
                    }
                }
            }
            feedback_area.style.display = 'block'
        }

        function add_to_list(e){
            if(this.checked){
                list_checked.push(this.id)
            }else{
                let index = array.indexOf(this.id)
                if (index > -1) {
                  list_checked.splice(index, 1)
                }
            }
        }

        function active(e){
            for(let i of nav_li){
                i.classList.remove('active')
            }                
            this.classList.add('active')
        }

        function get_user_info(fb_id){
            var display = document.getElementById('user_info')
            var span = user_info.querySelectorAll('span')
            var img = document.querySelector('#user_avatar img')
            axios.get('/manager/feedback/user_info/' + encodeURIComponent(fb_id))
            .then(function(response){
                if(response.status == 200){
                    var data = []
                    var res = response.data
                    img.setAttribute('src', res.profile_pic)
                    data.push(res.id)
                    data.push(res.first_name + " " + res.last_name)
                    data.push((res.gender == 'male')?'Name':'Nữ')
                    data.push(res.locale)
                    for(let i in data){
                        span[i].innerHTML = data[i]
                    }
                }
                else{
                    while (display.firstChild) {
                        display.removeChild(display.firstChild)
                        var p = document.createElement('p')
                        p.innerHTML = 'Đã có lỗi xảy ra, không thể hiển thị dữ liệu người dùng!'
                        display.appendChild(p)
                    }
                }
            })
            .catch(function(error){
                console.log(error)
            })
        }


    </script>
    <script>
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var modalImg = document.getElementById("img01");
        var captionText = document.getElementById("caption");
        function zoom(e){
          modal.style.display = "block"
          modalImg.src = this.src
          captionText.innerHTML = this.alt
        }

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close-modal")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
          modal.style.display = "none";
        }
    </script>
    <!-- END OF SELF ADDING SCRIPT -->
    <% include _layouts/global_plugin %>
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/assets/pages/scripts/table-datatables-managed.min.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL SCRIPTS -->
<% include _layouts/footer %>
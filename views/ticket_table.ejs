<% include _layouts/header %>
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/assets/apps/css/inbox.min.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">
    <% include _layouts/top_menu %>
    <!-- BEGIN HEADER & CONTENT DIVIDER -->
    <div class="clearfix"> </div>
    <!-- END HEADER & CONTENT DIVIDER -->
    <!-- BEGIN CONTAINER -->
    <div class="page-container">
        <% include _layouts/sidebar %>
        <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <!-- BEGIN PAGE TITLE -->
                        <div class="page-title">
                            <h1>Quản lý phản hồi từ người dùng
                            </h1>
                        </div>
                        <!-- END PAGE TITLE -->
                    </div>
                    <!-- END PAGE HEAD-->
                    <% include _layouts/breadcrumb %>
                     <!-- BEGIN PAGE BASE CONTENT -->
                    <div class="inbox">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-12">
                                        <!-- BEGIN SAMPLE TABLE PORTLET-->
                                        <div class="portlet box red">
                                            <div class="portlet-title">
                                                <div class="caption">
                                                    <i class="far fa-list-alt"></i>Ticket</div>
                                                <div class="tools" style="margin-left: 10px;" style="align-content: right">
                                                    <a class="collapse"> </a>
                                                </div>
                                            </div>
                                            <div class="portlet-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1_2">
                                                        <thead>
                                                            <tr>
                                                                <th style="display: none;">
                                                                    <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                                    <input type="checkbox" class="checkboxes" value="1" disabled />
                                                                    <span></span>
                                                                    </label>
                                                                </th>
                                                                <th> Ticket ID </th>
                                                                <th> Loại </th>
                                                                <th> Mã điểm bán </th>
                                                                <th> Người xử lý </th>
                                                                <th> Trạng thái </th>
                                                                <th> Cập nhật gần nhất </th>
                                                                <th> Độ ưu tiên </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                                <% for (var i = 0; i < tickets.length ; i++) { -%>
                                                                	<tr class="odd gradeX" id="<%= tickets[i].id %>">
	                                                                    <td style="display: none;">
                                                                            <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                                                                <input id="<%= tickets[i].id %>" type="checkbox" class="checkboxes" value="<%= tickets[i].id %>" <% if (tickets[i].status != 'closed') { -%>
                                                                                    disabled
                                                                                <% } -%>/>
                                                                                <span></span>
                                                                            </label>
	                                                                    </td>
	                                                                    <td> <%= tickets[i].id %> </td>
                                                                        <td> 
                                                                            <% if (tickets[i].type == 'feedback') { -%>
                                                                                Phản hồi
                                                                            <% } else { -%>
                                                                                Hỏi thông tin                              
                                                                            <% } -%>
                                                                        </td>
                                                                        <td>
                                                                            <%= tickets[i].member_profile.member_code %>
                                                                        </td>
                                                                        <td> <% if (tickets[i].assignee) { -%>
                                                                            <%= tickets[i].assignee %>
                                                                        <% } else { -%>
                                                                            -
                                                                        <% } -%> </td>
	                                                                    <td data-sort=<%= tickets[i].data_sort %>> 
                                                                            <%= tickets[i].status_string %> 
                                                                        </td>
	                                                                    <td> <% if (tickets[i].update_time_string) { -%>
                                                                            <%= tickets[i].update_time_string %>
                                                                        <% } else { -%>
                                                                            -
                                                                        <% } -%>  </td>
                                                                        <td> 
                                                                            <% if (tickets[i].priority == "high") { -%>
                                                                                <span class="label label-sm label-danger"> Cao </span>
                                                                            <% } else { -%>
                                                                                <span class="label label-sm label-warning"> Bình thường </span>
                                                                            <% } -%>
                                                                        </td>
                                                                	</tr>
                                                                <% } -%>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END SAMPLE TABLE PORTLET-->
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>
                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
            <div id="myModal" class="modal">
                <i class="far fa-times-circle close-modal"></i>
                <img class="modal-content" id="img01">
                <div id="caption"></div>
            </div>
    </div>
    <!-- END CONTAINER -->
    <% include _layouts/global_plugin %>
    <% include _layouts/socket %>
    <!-- SELF ADDING SCRIPT -->
    <script type="text/javascript">
        var list_checked = []

        function add_listener(){
            var ticket_row = document.querySelectorAll('#sample_1_2 tbody tr')
            for(let i of ticket_row){

                i.addEventListener('click', read_ticket)
                var j = i.querySelectorAll('td')[0]
                $(j).add(i).click(handler)
                j.addEventListener('click', add_to_list)
            }
        }

        add_listener()
        function handler(event) {
            event.stopPropagation()
        }

        //lấy dữ liệu về một feedback
        function read_ticket(e){
            window.open(`/manager/ticket/read/${this.id}`, '_blank')
        }

        //thêm feedback được đánh dấu trong checkbox
        function add_to_list(e){
            var checkbox = this.querySelector('label input')
            if(checkbox.checked && list_checked.indexOf(this.value) == -1){
                list_checked.push(this.value)
            }else{
                let index = list_checked.indexOf(this.value)
                if (index > -1) {
                  list_checked.splice(index, 1)
                }
            }
        }

        function del_ticket(){
            if(list_checked.length == 0){
                swal("Chú ý", 'Lựa chọn ít nhất một ticket ở trạng thái "closed" để xóa', "warning")
                return
            }

            var text = (list_checked.length == 1)?"Xóa ticket đã chọn":"Xóa các ticket đã chọn"
            var result = (list_checked.length == 1)?"Đã xóa ticket được chọn":"Đã xóa các ticket được lựa chọn"
            swal({
                title: "Xác nhận",
                text: text, 
                showCancelButton: true,
                confirmButtonText: "Tiếp tục",
                cancelButtonText: "Hủy bỏ",
                confirmButtonColor: 'orange',
                type: "warning",
                allowOutsideClick: false
            })
            .then(function(result){
                if(result.value){
                    axios.delete("/manager/ticket/delete", {
                        data: list_checked
                    })
                    .then(function(response){
                        if(response.status == 200){
                            swal("Thành công!", result, "success", {showConfirmButton: false})
                            setTimeout(function(){
                                location.reload()
                            }, 500)
                        }
                    })
                    .catch(function(error){
                        console.error(error)
                        swal("Lỗi!", error.response.data, "error", {confirmButtonColor: 'red'})
                    })
                }
            })
        }

    </script>
    <script type="text/javascript">
        socket.on('update feedback', function(data){   
            var row = document.getElementById(data.feedback._id)
            var labels = row.querySelectorAll('.label-feedback')
            if(data.feedback.status.read){
                labels[0].innerHTML = 'Đã đọc'
                labels[0].classList.remove('label-warning')
                labels[0].classList.add('label-success')
            }
            if(data.feedback.status.reply){
                labels[1].innerHTML = 'Đã trả lời'
                labels[1].classList.remove('label-danger')
                labels[1].classList.add('label-info')   
            }
            change_num()
        })
    </script>  
    <!-- END OF SELF ADDING SCRIPT -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="/assets/pages/scripts/table-datatables-managed.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL SCRIPTS -->
<% include _layouts/footer %>